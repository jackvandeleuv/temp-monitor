<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Erieview Temperature</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root{--pad:1.5rem}
    @media(max-width:600px){:root{--pad:1rem}}
    body{font-family:sans-serif;padding:var(--pad);background:#f9fafb;margin:0}
    h1{font-size:clamp(1.25rem,4vw,1.75rem);margin-bottom:1rem}
    #chartWrapper{max-width:900px;width:100%;margin:auto}
    canvas{background:#fff;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,.05);width:100%!important;min-height:260px}
    #controls{display:flex;flex-wrap:wrap;gap:.75rem;align-items:center;max-width:900px;margin:0 auto 1.25rem}
    #controls label{font-weight:600}
    #controls input{padding:.35rem .65rem;font-size:1rem}
    @media(max-width:600px){#controls{flex-direction:column;align-items:stretch}}
  </style>
</head>
<body>
  <h1>Erieview – 5th Floor Temperature (°F)</h1>
  <div id="controls">
    <label for="startInput">Start</label>
    <input id="startInput" type="date">
    <label for="endInput">End</label>
    <input id="endInput" type="date">
  </div>
  <div id="chartWrapper">
    <canvas id="myChart"></canvas>
  </div>
  <script>
    const ctx=document.getElementById('myChart').getContext('2d')
    const startInput=document.getElementById('startInput')
    const endInput=document.getElementById('endInput')
    const FILENAME='https://raw.githubusercontent.com/jackvandeleuv/temp-monitor-data/refs/heads/main/auto_temp_data.jsonl'
    let allData=[]
    let chart
    const DAY_MS=86400000
    function cToF(c){return c*9/5+32}
    function parseLocalDate(str){
      const [y,m,d]=str.split('-').map(Number)
      return new Date(y,m-1,d)
    }
    async function loadData(){
      const r=await fetch(FILENAME)
      if(!r.ok)throw new Error('HTTP '+r.status)
      const t=await r.text()
      allData=t.trim().split(/\n+/).map(l=>JSON.parse(l))
    }
    function bucketAndAverage(filtered){
      const buckets=new Map()
      for(const d of filtered){
        const ts=Math.floor(d.timestamp/1800)*1800
        if(!buckets.has(ts))buckets.set(ts,[])
        buckets.get(ts).push(d.temperature)
      }
      const keys=[...buckets.keys()].sort((a,b)=>a-b)
      const labels=[]
      const tempsF=[]
      for(const k of keys){
        const temps=buckets.get(k)
        const avgC=temps.reduce((s,t)=>s+t,0)/temps.length
        labels.push(new Date(k*1000).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'}))
        tempsF.push(cToF(avgC).toFixed(1))
      }
      return {labels,tempsF}
    }
    function updateChart(){
      if(!startInput.value||!endInput.value)return
      const startDate=parseLocalDate(startInput.value)
      const endDate=parseLocalDate(endInput.value)
      if(isNaN(startDate)||isNaN(endDate)||startDate>endDate)return
      startDate.setHours(0,0,0,0)
      endDate.setHours(23,59,59,999)
      const startMs=startDate.getTime()
      const endMs=endDate.getTime()
      const filtered=allData.filter(d=>{
        const ms=d.timestamp*1000
        return ms>=startMs&&ms<=endMs
      })
      if(filtered.length===0)return
      const {labels,tempsF}=bucketAndAverage(filtered)
      if(chart)chart.destroy()
      chart=new Chart(ctx,{type:'line',data:{labels,datasets:[{label:'Temperature (°F)',data:tempsF,borderWidth:2,fill:false,tension:.3}]},options:{responsive:true,interaction:{mode:'index',intersect:false},scales:{y:{type:'linear',title:{display:true,text:'Temperature (°F)'}}},plugins:{legend:{position:'top'}}}})
    }
    function formatLocalDate(d){
      const yr=d.getFullYear()
      const mo=(d.getMonth()+1).toString().padStart(2,'0')
      const da=d.getDate().toString().padStart(2,'0')
      return `${yr}-${mo}-${da}`
    }
    function initInputs(){
      const today=new Date()
      const todayStr=formatLocalDate(today)
      startInput.value=todayStr
      endInput.value=todayStr
    }
    async function init(){
      initInputs()
      await loadData()
      updateChart()
    }
    startInput.addEventListener('change',updateChart)
    endInput.addEventListener('change',updateChart)
    init()
  </script>
</body>
</html>
